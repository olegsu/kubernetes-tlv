version: '1.0'
steps:

  build_step:
    title: Building docker image
    type: build
    dockerfile: Dockerfile
    image_name: codefresh/kubernetes-tlv
    metadata:
      set:
        - CF_QUALITY: true

  unit_test:
    title: Running unit test
    image: codefresh/cli
    commands:
    - sh bin/unit-test.sh
    on_success:
      metadata:
        set:
          - '${{build_step.imageId}}':
              - Unit_Test: 'Pass'
        
  helm_package:
    title: Building helm package from current commit
    image: codefresh/kube-helm:master
    commands:
    - ./bin/package-chart.sh

  push:
    title: Pushing image to Dockerhub
    type: push
    image_name: codefresh/kubernetes-tlv
    candidate: ${{build_step}}
    tags:
    - ${{VERSION}}
    - ${{CF_BRANCH_TAG_NORMALIZED}}
    - ${{CF_SHORT_REVISION}}

  run_cd:
    title: Executing CD pipeline
    image: codefresh/cli
    commands:
    - sh bin/run-cd.sh
    fail_fast: false